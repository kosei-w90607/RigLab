# 要件定義書

## 1. 概要

### 1.1 プロジェクト名
**RigLab**

### 1.2 目的
PC初心者から自作経験者まで、誰でも簡単にPC構成を作成・比較できるWebアプリケーションを提供する。

### 1.3 スコープ
- Phase 1: 基本機能（手動パーツ登録、おまかせ構成、カスタム構成）
- Phase 2: 外部API連携（Rakuten Product API / 楽天商品検索API）

---

## 2. 機能要件

### 2.1 ユーザー向け機能

#### FR-001: おまかせ構成提案
| 項目 | 内容 |
|------|------|
| 概要 | 予算・用途から最適なPC構成を提案する |
| 入力 | 予算（任意）、用途（任意）、またはその両方 |
| 出力 | 推奨パーツ構成、合計価格、性能目安 |
| 優先度 | 高 |

**用途カテゴリ:**
| カテゴリ | 説明 | 想定スペック |
|----------|------|-------------|
| ゲーム用 | FPS、RPG等のゲームプレイ | 高GPU、中〜高CPU |
| クリエイティブ用 | 動画編集、配信、3DCG | 高CPU、高メモリ、高GPU |
| 事務・普段使い | Office、Web閲覧 | 低〜中スペック |

**予算帯:**
| 帯域 | 価格範囲 |
|------|---------|
| エントリー | 〜15万円 |
| ミドル | 15〜30万円 |
| ハイエンド | 30万円〜 |

#### FR-002: カスタム構成作成
| 項目 | 内容 |
|------|------|
| 概要 | ユーザーが主要パーツを選び、付随パーツは自動推奨されるPC構成作成 |
| 機能 | パーツ選択、**互換性フィルタリング**、付随パーツ自動推奨、合計価格自動計算、構成保存 |
| 優先度 | 高 |

**設計思想:**
- **「選ばせる」UI**: システムが自動決定するのではなく、互換性のある選択肢をフィルタリングして表示し、ユーザーが予算と相談して自分で選ぶ
- **ターゲットユーザー**: CPU/GPU/メモリは分かるが、電源・マザボ・ケースの互換性が分からない「浅めのPCゲーマー」

**ユーザーが選択するパーツ:**
- CPU
- GPU（グラフィックボード）
- メモリ
- ストレージ（3スロット固定）
  - プライマリ: SSD必須（OS用）
  - セカンダリ: SSD/HDD任意（データ用）
  - 追加: SSD/HDD任意（大容量用）
- OS（エディション選択）

**OS選択肢:**
| エディション | 価格帯 | 主な違い |
|-------------|--------|---------|
| Windows 11 Home | 約15,000円 | 一般家庭向け、基本機能 |
| Windows 11 Pro | 約23,000円 | BitLocker暗号化、リモートデスクトップ、Hyper-V対応 |

**自動推奨されるパーツ:**
- マザーボード（CPUソケット・メモリタイプに基づき自動選択）
- 電源（CPU+GPUのTDPから必要容量を計算し推奨）
- ケース（マザーボードのフォームファクタに基づき推奨）

**互換性フィルタリング仕様:**
| 選択パーツ | フィルタリング対象 | フィルタリング条件 |
|-----------|------------------|-------------------|
| CPU | マザーボード | CPUソケット一致 |
| CPU | メモリ | メモリタイプ（DDR4/DDR5）一致 |
| マザーボード | ケース | フォームファクタ対応（ATX/mATX/ITX） |
| GPU | ケース | カード長がケース最大対応長以下 |

**UI仕様:**
- 1画面でパーツ選択を完結（画面遷移なし）
- CPU選択後 → マザボ・メモリの選択肢がフィルタリングされる
- GPU選択後 → ケースの選択肢がフィルタリングされる
- ステップナビゲーションは不要

**推奨ロジック:**
| パーツ | 推奨基準 |
|--------|---------|
| 電源 | (CPU TDP + GPU TDP) × 1.5 以上の容量 |
| マザーボード | CPUソケット対応 + メモリタイプ対応 |
| ケース | マザーボードのフォームファクタ（ATX/mATX/ITX）対応 |

#### FR-003: 構成保存・管理
| 項目 | 内容 |
|------|------|
| 概要 | 作成した構成を保存・編集・削除する |
| 条件 | ログインユーザーのみ |
| 優先度 | 中 |

#### FR-004: 構成共有
| 項目 | 内容 |
|------|------|
| 概要 | 作成した構成をURLで共有する |
| 方式 | トークンベース共有（share_tokensテーブルにパーツ構成をJSON保存し、短縮URLで共有） |
| 条件 | ログイン不要で発行・閲覧可能 |
| 機能 | OG画像生成（構成リスト表示）、X共有ボタン |
| 共有URL | `/share/:token` 形式。保存済み構成はpc_custom_setsのshare_token、未保存構成はshare_tokensテーブルを使用 |
| 優先度 | 中 |

#### FR-005: ユーザー認証
| 項目 | 内容 |
|------|------|
| 概要 | ユーザー登録・ログイン・ログアウト |
| 方式 | NextAuth.js (Auth.js) によるCredentials認証 + Google OAuth |
| バックエンド連携 | Rails APIで認証情報を検証 |
| メール確認 | ユーザー登録時にメール確認トークンを発行し、確認完了後にログイン可能 |
| パスワードリセット | メールアドレスでリセットトークンを発行し、新パスワードを設定 |
| 優先度 | 高 |

> 詳細仕様: `docs/13_auth-enhancement-spec.md`

#### FR-006: 価格動向・履歴表示
| 項目 | 内容 |
|------|------|
| 概要 | パーツの価格推移をカテゴリ別・個別に閲覧できる |
| 機能 | カテゴリ一覧（平均価格・トレンド表示）、カテゴリ別パーツ価格推移、個別パーツ価格履歴グラフ |
| データソース | 楽天商品検索APIから定期取得し、parts_price_historiesテーブルに蓄積 |
| 優先度 | 中 |

#### FR-007: パーツランキング
| 項目 | 内容 |
|------|------|
| 概要 | パーツカテゴリ別の人気ランキングを表示する |
| 機能 | カテゴリ指定でランキング取得（楽天ランキングAPIベース） |
| 優先度 | 中 |

#### FR-008: 購入タイミングアドバイス
| 項目 | 内容 |
|------|------|
| 概要 | 価格履歴に基づき、パーツの購入タイミングをアドバイスする |
| 機能 | カテゴリ横断のサマリー表示、個別パーツの買い時判定（buy/wait/neutral） |
| 優先度 | 低 |

### 2.2 管理者向け機能

#### FR-101: パーツ管理
| 項目 | 内容 |
|------|------|
| 概要 | パーツの登録・編集・削除 |
| 対象 | CPU、GPU、メモリ、ストレージ、OS、その他 |
| 優先度 | 高 |

#### FR-102: おまかせ構成管理
| 項目 | 内容 |
|------|------|
| 概要 | おまかせ構成テンプレートの登録・編集・削除 |
| 優先度 | 高 |

#### FR-103: ユーザー管理
| 項目 | 内容 |
|------|------|
| 概要 | ユーザー一覧表示、権限管理 |
| 優先度 | 低 |

---

## 3. 非機能要件

### 3.1 対応環境

#### NFR-001: デバイス対応
| デバイス | 対応 |
|----------|------|
| PC（Chrome, Firefox, Safari, Edge） | ○ |
| スマートフォン（iOS Safari, Android Chrome） | ○ |
| タブレット | ○ |

#### NFR-002: レスポンシブデザイン
- モバイルファースト設計
- ブレークポイント: 640px / 768px / 1024px / 1280px

### 3.2 パフォーマンス

#### NFR-003: レスポンス時間
| 操作 | 目標 |
|------|------|
| ページ読み込み | 3秒以内 |
| API応答 | 500ms以内 |
| 検索結果表示 | 1秒以内 |

### 3.3 セキュリティ

#### NFR-004: レート制限
| 項目 | 要件 |
|------|------|
| 実装方式 | Rack::Attackによるレート制限 |
| API全般 | 300リクエスト/分（IPベース） |
| 認証エンドポイント | 20リクエスト/分（IPベース） |
| パスワードリセット | 3回/時間（emailベース） |
| メール確認再送 | 3回/時間（emailベース） |

#### NFR-005: 通信セキュリティ
| 項目 | 要件 |
|------|------|
| HTTPS | 本番環境では必須 |
| CORS | 許可オリジンを明示的に設定 |
| CSP | Content-Security-Policy ヘッダー設定 |

#### NFR-006: データ保護
| 項目 | 要件 |
|------|------|
| パスワード | bcryptでハッシュ化（コスト係数12） |
| 個人情報 | メールアドレスのみ保存、最小限の収集 |
| SQLインジェクション | Active Record のパラメータバインディング |
| XSS | React のエスケープ機能を活用、生HTMLの埋め込み禁止 |
| API認証 | JWT認証 + CORS制御（APIモードのためCSRFトークン不使用） |

#### NFR-007: 権限管理
| ロール | 権限 |
|--------|------|
| ゲスト | 構成閲覧、おまかせ提案、カスタム作成（保存不可）、構成共有 |
| ユーザー | ゲスト権限 + 構成保存・編集・削除 |
| 管理者 | 全権限 + パーツ管理・おまかせ構成管理 |

### 3.4 可用性

#### NFR-008: 稼働率
- 目標: 99%以上（個人プロジェクトとして）

---

## 4. 制約事項

### 4.1 技術制約
- フロントエンド: Next.js 15 (App Router) + Tailwind CSS
- バックエンド: Rails 7.1 API
- データベース: MySQL 8.0 (開発) / PostgreSQL 15 (本番)
- 認証: NextAuth.js (Auth.js)
- **セキュリティ**: Next.js 15.2.3以上必須（CVE-2025-29927対策）

### 4.2 スケジュール制約
- Phase 1: MVP（基本機能）を優先

### 4.3 コスト制約
- Phase 1ではAPI連携の月額費用を避ける（手動登録）

---

## 5. 用語定義

| 用語 | 定義 |
|------|------|
| おまかせ構成 | システムが予算・用途に基づいて提案するPC構成 |
| カスタム構成 | ユーザーが自由に作成するPC構成 |
| パーツ | PCを構成する部品（CPU、GPU等） |
| 構成 | 複数のパーツを組み合わせたPCのセット |

---

## 6. 改訂履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-01-12 | 1.0 | 初版作成 |
| 2025-01-12 | 1.1 | セキュリティ要件を詳細化 |
| 2025-01-15 | 1.2 | 技術スタック変更（Next.js + NextAuth.js）、構成共有を非ログイン対応に変更 |
| 2025-01-15 | 1.3 | OS選択肢を詳細化（Windows 11 Home/Pro） |
| 2026-01-31 | 1.4 | FR-002: 「選ばせる」UI要件・互換性フィルタリング仕様を追加 |
| 2026-01-31 | 1.5 | 予算帯を現実価格に合わせて修正（エントリー: ~10万→~15万, ミドル: 10-30万→15-30万） |
| 2026-02-18 | 2.1 | 実装との乖離修正 — トークンベース共有、認証拡張（Google OAuth・メール確認・パスワードリセット）、Rakuten API、価格動向機能（FR-006〜FR-008）、Rack::Attackレート制限の実装反映 |
