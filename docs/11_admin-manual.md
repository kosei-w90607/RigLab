# 管理者向け運用マニュアル

## 1. 管理画面へのアクセス

### 1.1 URL

| 環境 | URL |
|------|-----|
| ローカル開発 | http://localhost:3000/admin |
| 本番 | https://riglab.app/admin |

### 1.2 アクセス権限

管理画面には `admin` ロールを持つユーザーのみアクセスできます。
`admin` 以外のユーザーがアクセスした場合は「アクセス権限がありません」と表示されます。
未ログインの場合はサインインページにリダイレクトされます。

### 1.3 初期管理者アカウント（開発環境）

シードデータで作成される管理者アカウント:

| 項目 | 値 |
|------|-----|
| メールアドレス | admin@example.com |
| パスワード | admin123 |
| ロール | admin |

> **注意:** 本番環境では必ずパスワードを変更してください。

---

## 2. 管理画面の構成

管理画面は左サイドバーで以下のセクションに分かれています。

| メニュー | パス | 機能 |
|---------|------|------|
| ダッシュボード | /admin | パーツ数・プリセット数・ユーザー数の概要表示 |
| パーツ管理 | /admin/parts | 全カテゴリのパーツCRUD |
| プリセット管理 | /admin/presets | おまかせ構成のCRUD |
| ユーザー管理 | /admin/users | ユーザー一覧・ロール変更 |

---

## 3. パーツ管理

### 3.1 パーツ一覧

**パス:** `/admin/parts`

パーツカテゴリ（CPU, GPU, メモリ, ストレージ, OS, マザーボード, 電源, ケース）ごとにパーツの一覧を表示します。

- カテゴリはタブで切り替え可能
- 各パーツの名前、メーカー、価格が表示される
- 価格順ソート対応

### 3.2 パーツの新規作成

**パス:** `/admin/parts/new`

1. パーツ管理ページで「新規作成」ボタンをクリック
2. カテゴリを選択
3. 必須項目を入力:
   - **共通:** 名前、メーカー、価格
   - **CPU:** ソケット、TDP、メモリタイプ、スペック（コア数、スレッド数、クロック等）
   - **GPU:** TDP、長さ(mm)、スペック（VRAM等）
   - **メモリ:** メモリタイプ、スペック（容量、速度、モジュール数）
   - **ストレージ:** スペック（容量、タイプ、インターフェース、読み書き速度）
   - **OS:** スペック（バージョン）
   - **マザーボード:** ソケット、メモリタイプ、フォームファクタ、スペック（チップセット、スロット数等）
   - **電源:** ワット数、フォームファクタ、スペック（効率、モジュラー方式）
   - **ケース:** フォームファクタ、最大GPU長(mm)、スペック（CPUクーラー高さ）
4. 「保存」ボタンをクリック

### 3.3 パーツの編集

**パス:** `/admin/parts/[id]`

1. パーツ一覧で対象パーツの「編集」ボタンをクリック
2. 必要な項目を修正
3. 「更新」ボタンをクリック

### 3.4 パーツの削除

1. パーツ一覧で対象パーツの「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

> **注意:** プリセットで使用されているパーツを削除すると、該当プリセットが正しく表示されなくなる可能性があります。削除前に参照状況を確認してください。

---

## 4. プリセット管理

### 4.1 プリセット一覧

**パス:** `/admin/presets`

登録済みのおまかせ構成（プリセット）を一覧表示します。

- 名前、予算帯、用途が表示される
- 各プリセットの詳細を確認可能

### 4.2 プリセットの新規作成

**パス:** `/admin/presets/new`

1. プリセット管理ページで「新規作成」ボタンをクリック
2. 以下の項目を入力:
   - **名前:** プリセット名（例: エントリーゲーミングPC）
   - **説明:** プリセットの説明文
   - **予算帯:** `entry`（~15万円）/ `mid`（~20万円）/ `high`（~30万円）/ `premium`（30万円〜）
   - **用途:** `gaming` / `creative` / `office`
   - **パーツ選択:** CPU, GPU, メモリ, ストレージ(1~3), OS, マザーボード, 電源, ケースを選択
3. 「保存」ボタンをクリック

### 4.3 プリセットの編集

**パス:** `/admin/presets/[id]`

1. プリセット一覧で対象プリセットの「編集」ボタンをクリック
2. 必要な項目を修正
3. 「更新」ボタンをクリック

### 4.4 プリセットの削除

1. プリセット一覧で対象プリセットの「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

### 4.5 予算帯・用途の組み合わせ

| 予算帯 | 値 | 目安 |
|--------|------|------|
| エントリー | entry | ~15万円 |
| ミドル | mid | ~20万円 |
| ハイエンド | high | ~30万円 |
| プレミアム | premium | 30万円〜 |

| 用途 | 値 |
|------|------|
| ゲーミング | gaming |
| クリエイティブ | creative |
| オフィス | office |

予算帯4種 x 用途3種 = 12通りの組み合わせを網羅することを推奨します。

---

## 5. ユーザー管理

### 5.1 ユーザー一覧

**パス:** `/admin/users`

登録済みユーザーの一覧を表示します。

- メールアドレス、名前、ロール、登録日が表示される
- ページネーション対応

### 5.2 ロール変更

1. ユーザー一覧で対象ユーザーの行を確認
2. ロール列のセレクトボックスで `ユーザー` または `管理者` を選択
3. 変更は即時反映される

| ロール | 値 | 権限 |
|--------|------|------|
| ユーザー | user | 一般機能の利用（構成作成・保存・共有） |
| 管理者 | admin | 管理画面へのアクセス、全データのCRUD |

> **注意:** 自分自身のロールを `user` に変更すると管理画面にアクセスできなくなります。最低1名の管理者を維持してください。

---

## 6. シードデータの投入

### 6.1 開発環境（Docker）

```bash
# シードデータ投入
docker compose exec back bundle exec rails db:seed

# データベースのリセット + シードデータ投入
docker compose exec back bundle exec rails db:reset
```

### 6.2 本番環境

```bash
# シードデータ投入（本番環境では慎重に実行）
RAILS_ENV=production bundle exec rails db:seed
```

> **注意:** `db:seed` はべき等に実装されています（`find_or_create_by!` を使用）。既存データがある場合は重複作成されません。

### 6.3 シードデータの内容

`backend/db/seeds.rb` で以下のデータが投入されます:

| データ | 件数目安 | 内容 |
|--------|---------|------|
| CPU | 16 | Intel 13th/14th/15th Gen, AMD Ryzen 7000/9000 |
| GPU | 11 | NVIDIA RTX 4000, AMD RX 7000 |
| メモリ | 7 | DDR4/DDR5各種 |
| ストレージ | 9 | NVMe SSD, SATA SSD, HDD |
| OS | 3 | Windows 11 Home/Pro, Ubuntu |
| マザーボード | 11 | LGA1700/LGA1851/AM5 各種 |
| 電源 | 8 | 650W~1000W |
| ケース | 7 | ATX各種 |
| プリセット | 9 | 予算帯3 x 用途3 |
| ユーザー | 2 | admin@example.com, user@example.com |

---

## 7. トラブルシューティング

### 7.1 管理画面にアクセスできない

**症状:** 管理画面にアクセスすると「アクセス権限がありません」と表示される

**対処:**
1. ログイン中のユーザーのロールが `admin` であることを確認
2. Railsコンソールでロールを確認:
   ```bash
   docker compose exec back bundle exec rails console
   > User.find_by(email: 'admin@example.com').role
   ```
3. ロールがuserの場合はadminに変更:
   ```bash
   > User.find_by(email: 'admin@example.com').update!(role: 'admin')
   ```

### 7.2 パーツが表示されない

**症状:** パーツ管理ページでパーツが表示されない

**対処:**
1. シードデータが投入済みか確認:
   ```bash
   docker compose exec back bundle exec rails console
   > PartsCpu.count
   ```
2. 0の場合はシードデータを投入:
   ```bash
   docker compose exec back bundle exec rails db:seed
   ```

### 7.3 APIエラーが発生する

**症状:** 管理画面で操作すると「エラーが発生しました」と表示される

**対処:**
1. バックエンドのログを確認:
   ```bash
   docker compose logs -f back
   ```
2. データベース接続を確認:
   ```bash
   docker compose exec back bundle exec rails db:migrate:status
   ```
3. マイグレーションが未実行の場合:
   ```bash
   docker compose exec back bundle exec rails db:migrate
   ```

### 7.4 レートリミットに引っかかる

**症状:** APIリクエストが429エラーを返す

**対処:**
- Rack::Attackの設定: API全般は300req/min（IP単位）、認証エンドポイントは20req/min（IP単位）
- パスワードリセットは3回/hour（メール単位）、メール確認再送は3回/hour（メール単位）
- 開発環境ではRack::Attackは無効化されている
- 本番環境で問題が発生した場合、制限値の調整は `backend/config/initializers/rack_attack.rb` を編集

---

## 8. 楽天検索インポート

### 8.1 概要

**パス:** `/admin/parts/import`

楽天商品検索APIを使用してパーツデータを検索し、検索結果からパーツをインポートする機能です。

### 8.2 操作手順

1. 管理画面サイドバーの「パーツ管理」→「インポート」をクリック（または `/admin/parts/import` に直接アクセス）
2. カテゴリを選択（CPU, GPU, メモリ等）
3. キーワードを入力して検索
4. 楽天商品検索APIの結果が一覧表示される
5. インポートしたいパーツを選択
6. 「インポート」ボタンをクリック

### 8.3 注意事項

- 楽天APIの利用にはアプリケーションIDが必要です（環境変数 `RAKUTEN_APPLICATION_ID`）
- APIのレート制限に注意してください（楽天API側の制限）
- インポート後のパーツデータは必要に応じて編集画面で調整してください

---

## 9. 価格取得管理

### 9.1 手動価格取得

管理者ダッシュボードから手動で価格取得を実行できます。

- **エンドポイント:** `POST /api/v1/admin/price_fetch`
- **操作:** 管理画面の価格取得ボタンをクリック
- **実行内容:** 楽天APIから全パーツの最新価格を取得し、価格履歴を更新

### 9.2 定期自動取得

GitHub Actionsのcronジョブにより、自動的に価格を取得します。

- **スケジュール:** 毎日 JST 3:00
- **ワークフロー:** `.github/workflows/price-fetch.yml`
- **認証:** `CRON_SECRET` による Bearer トークン認証
- **エンドポイント:** `POST /api/v1/cron/price_fetch`

### 9.3 必要な設定

| 設定場所 | キー | 説明 |
|---------|------|------|
| Render環境変数 | `CRON_SECRET` | 認証トークン |
| Render環境変数 | `RAKUTEN_APPLICATION_ID` | 楽天APIアプリケーションID |
| GitHub Secrets | `RENDER_API_URL` | Render本番URL |
| GitHub Secrets | `CRON_SECRET` | 認証トークン（Render環境変数と同じ値） |

---

## 10. バックアップと復元

データベースのバックアップ・復元手順については [デプロイ手順書 セクション9](./08_deploy-guide.md#9-バックアップと復元) を参照してください。

---

## 11. 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026-02-07 | 初版作成 |
| 2026-02-18 | 予算帯をentry/mid/high/premiumの4段階に更新、楽天検索インポート機能セクション追加、価格取得管理セクション追加、Rack::Attackレート制限を実装に合わせて修正 |
