# テストガイド

本ドキュメントは、PC RigLabプロジェクトのテスト方針と実行方法について説明します。

---

## 1. 概要

### テストの棲み分け

| テスト種別 | 対象 | ツール |
|-----------|------|--------|
| 単体テスト | バックエンドAPI、モデル、サービス | RSpec |
| E2Eテスト | フロントエンド主要フロー | Playwright |
| 手動テスト | 認証連携、セッション管理、レート制限 | 本ドキュメントのチェックリスト |

---

## 2. 自動テスト

### 2.1 RSpec（バックエンド）

```bash
# 全テスト実行
docker compose exec back bundle exec rspec

# 特定のファイルを実行
docker compose exec back bundle exec rspec spec/models/parts_cpu_spec.rb

# 特定のテストを実行（行番号指定）
docker compose exec back bundle exec rspec spec/models/parts_cpu_spec.rb:10
```

### 2.2 Playwright（E2Eテスト）

```bash
# フロントエンドコンテナ内で実行
cd frontend

# 全E2Eテスト実行
npx playwright test

# 特定のテストファイルを実行
npx playwright test e2e/admin.spec.ts

# UIモードで実行（デバッグ用）
npx playwright test --ui

# ヘッドフルモードで実行（ブラウザ表示）
npx playwright test --headed
```

### 2.3 テストカバレッジ

**バックエンド:**
- モデルバリデーション: 100%
- APIエンドポイント: 主要フロー100%
- サービスロジック: 100%

**フロントエンド（E2E）:**
- トップページ表示: ✅
- おまかせ構成フロー: ✅
- カスタム構成基本操作: ✅
- 管理画面基本操作: ✅

---

## 3. 手動テスト チェックリスト

E2Eテストでカバーできない項目を手動で確認します。

### 3.1 認証機能

**前提条件:**
- バックエンドAPIが起動していること
- テスト用ユーザーが存在すること

| # | テスト項目 | 手順 | 期待結果 | 確認 |
|---|-----------|------|----------|------|
| AUTH-01 | 新規登録成功 | 1. `/signup` にアクセス<br>2. 有効なメールとパスワードを入力<br>3. 登録ボタンをクリック | ホーム `/` へリダイレクトされる | [ ] |
| AUTH-02 | 無効な認証情報エラー | 1. `/signin` にアクセス<br>2. 存在しないメールまたは間違ったパスワードを入力<br>3. ログインボタンをクリック | エラーメッセージが表示される | [ ] |
| AUTH-03 | Google OAuthログイン（正常系） | 1. `/signin` にアクセス<br>2. 「Googleでログイン」ボタンをクリック<br>3. Google認証画面で認証を完了 | ホーム `/` へリダイレクトされ、ユーザーが作成/ログインされる | [ ] |
| AUTH-04 | Google OAuthログイン（異常系） | 1. `/signin` にアクセス<br>2. 「Googleでログイン」ボタンをクリック<br>3. Google認証画面でキャンセル | サインインページに戻りエラーメッセージが表示される | [ ] |
| AUTH-05 | パスワードリセット（メール送信→リセット完了） | 1. `/signin` のパスワードリセットリンクをクリック<br>2. 登録済みメールアドレスを入力して送信<br>3. メールのリセットリンクをクリック<br>4. 新しいパスワードを入力して確定 | パスワードが変更され、新パスワードでログインできる | [ ] |
| AUTH-06 | メール認証（登録→確認メール→認証完了） | 1. `/signup` で新規登録<br>2. 確認メールを受信<br>3. メールの認証リンクをクリック | メール認証が完了し、アカウントが有効化される | [ ] |
| AUTH-07 | 確認メール再送信 | 1. 未認証のアカウントでログイン試行<br>2. 「確認メールを再送信」リンクをクリック<br>3. メールアドレスを入力して送信 | 確認メールが再送信される | [ ] |

### 3.2 管理者画面

**前提条件:**
- 一般ユーザーアカウントが存在すること
- 管理者アカウント（`role: admin`）が存在すること

| # | テスト項目 | 手順 | 期待結果 | 確認 |
|---|-----------|------|----------|------|
| ADMIN-01 | 一般ユーザーのアクセス拒否 | 1. 一般ユーザーでログイン<br>2. `/admin` に直接アクセス | アクセス拒否またはホームへリダイレクト | [ ] |
| ADMIN-02 | 管理者のアクセス許可 | 1. 管理者ユーザーでログイン<br>2. `/admin` にアクセス | 管理ダッシュボードが表示される | [ ] |
| ADMIN-03 | サイドバー: パーツ管理リンク | 1. 管理画面を開く<br>2. サイドバーを確認 | 「パーツ管理」リンクが存在する | [ ] |
| ADMIN-04 | サイドバー: プリセット管理リンク | 1. 管理画面を開く<br>2. サイドバーを確認 | 「プリセット管理」リンクが存在する | [ ] |
| ADMIN-05 | パーツ管理リンク遷移 | 1. サイドバーの「パーツ管理」をクリック | `/admin/parts` に遷移する | [ ] |
| ADMIN-06 | プリセット管理リンク遷移 | 1. サイドバーの「プリセット管理」をクリック | `/admin/presets` に遷移する | [ ] |

### 3.3 カスタム構成

**前提条件:**
- パーツデータ（CPU、GPU、メモリ等）がシードされていること

| # | テスト項目 | 手順 | 期待結果 | 確認 |
|---|-----------|------|----------|------|
| CONFIG-01 | CPU選択によるメモリフィルタリング | 1. `/configurator` にアクセス<br>2. CPUを選択<br>3. メモリ選択肢を確認 | 選択したCPUと互換性のあるメモリのみ表示される（DDR4/DDR5フィルタ） | [ ] |
| CONFIG-02 | GPU選択によるケースフィルタリング | 1. `/configurator` にアクセス<br>2. GPUを選択<br>3. ケース選択肢を確認 | 選択したGPUが収まるサイズのケースのみ表示される | [ ] |
| CONFIG-03 | 保存ボタンでモーダル表示 | 1. `/configurator` にアクセス<br>2. 全パーツを選択<br>3. 「構成を保存」ボタンをクリック | 保存確認モーダルが表示される | [ ] |
| CONFIG-04 | URLパラメータによる初期選択 | 1. URLに `?cpu=1&gpu=2` のようなパラメータを付与してアクセス | 該当パーツが初期選択された状態で表示される | [ ] |

### 3.4 共有機能

**前提条件:**
- 保存済みの構成が存在すること

| # | テスト項目 | 手順 | 期待結果 | 確認 |
|---|-----------|------|----------|------|
| SHARE-01 | 共有リンクで構成表示 | 1. 有効な共有URL `/share?cpu=1&gpu=2&...` にアクセス | 構成内容が正しく表示される | [ ] |
| SHARE-02 | カスタマイズボタン動作 | 1. 共有ページを表示<br>2. 「この構成をカスタマイズ」ボタンをクリック | `/configurator` に同じ構成で遷移する | [ ] |

### 3.5 セキュリティ（レート制限）

**注意:** これらのテストは本番環境に影響を与える可能性があるため、開発環境で実施すること。

| # | テスト項目 | 手順 | 期待結果 | 確認 |
|---|-----------|------|----------|------|
| SEC-01 | Rack::Attackレート制限（認証） | 1. 同一IPから認証エンドポイントへ20req/min以上のリクエストを送信 | 制限超過後はHTTP 429が返される | [ ] |
| SEC-03 | パスワードリセット レート制限 | 1. 同一メールアドレスでパスワードリセットを1時間に3回以上リクエスト | 制限超過後はHTTP 429が返される | [ ] |
| SEC-04 | メール確認再送 レート制限 | 1. 同一メールアドレスでメール確認再送を1時間に3回以上リクエスト | 制限超過後はHTTP 429が返される | [ ] |
| SEC-02 | API レート制限 | 1. 同一IPから300req/min以上のAPIリクエストを送信 | 制限超過後はHTTP 429が返される | [ ] |

---

## 4. リリース前チェックリスト

本番リリース前に以下の全項目を確認してください。

### 4.1 自動テスト

- [ ] RSpec: 全テストがパス
- [ ] Playwright E2E: 全テストがパス
- [ ] Lint/型チェック: エラーなし

### 4.2 手動テスト

- [ ] 認証機能（AUTH-01〜AUTH-07）: 全項目クリア
- [ ] 管理者画面（ADMIN-01〜ADMIN-06）: 全項目クリア
- [ ] カスタム構成（CONFIG-01〜CONFIG-04）: 全項目クリア
- [ ] 共有機能（SHARE-01〜SHARE-02）: 全項目クリア
- [ ] セキュリティ（SEC-01〜SEC-04）: 全項目クリア

### 4.3 環境確認

- [ ] 本番用環境変数が正しく設定されている
- [ ] データベースマイグレーションが完了している
- [ ] シードデータが投入されている（必要な場合）
- [ ] SSL証明書が有効

### 4.4 パフォーマンス

- [ ] 主要ページの初回読み込みが3秒以内
- [ ] APIレスポンスが500ms以内

---

## 5. 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026-02-03 | 初版作成（手動テストチェックリスト追加） |
| 2026-02-18 | 認証テストケース追加（Google OAuth、パスワードリセット、メール認証、確認メール再送）、SEC-01をRack::Attackレート制限に修正、パスワードリセット/メール確認再送のレート制限テスト追加 |
