name: Daily Price Fetch
on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = JST 3:00
  workflow_dispatch: # 手動トリガーも可能

jobs:
  fetch-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger price fetch
        env:
          RENDER_API_URL: ${{ secrets.RENDER_API_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          RESPONSE=$(curl -sf -X POST \
            "${RENDER_API_URL}/api/v1/cron/price_fetch" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json")

          echo "### Price Fetch Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | $(echo "$RESPONSE" | jq -r '.data.total // "N/A"') |" >> $GITHUB_STEP_SUMMARY
          echo "| Success | $(echo "$RESPONSE" | jq -r '.data.success // "N/A"') |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $(echo "$RESPONSE" | jq -r '.data.failed // "N/A"') |" >> $GITHUB_STEP_SUMMARY

          FAILED=$(echo "$RESPONSE" | jq -r '.data.failed // 0')
          if [ "$FAILED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Errors ($FAILED)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$RESPONSE" | jq -r '.data.errors[]' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
